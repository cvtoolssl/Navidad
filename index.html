<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CV Tools - Reto de Navidad ULTIMATE</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body { margin: 0; background-color: #050505; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        #game-container { 
            position: relative; width: 100%; max-width: 500px; height: 100vh; margin: 0 auto; 
            overflow: hidden; border-left: 5px solid #555; border-right: 5px solid #555; 
            box-shadow: 0 0 80px rgba(0,0,0,0.9); 
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); /* Cielo nocturno */
        }

        /* --- FONDO PARALLAX --- */
        .parallax-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        
        /* Capa 1: Monta√±as */
        .bg-mountains {
            background-image: linear-gradient(to bottom, transparent 60%, #0a0a0a 60%), 
                              linear-gradient(135deg, transparent 45%, #151515 50%, transparent 55%), 
                              linear-gradient(225deg, transparent 45%, #151515 50%, transparent 55%);
            background-size: 100% 100%, 120px 100px, 120px 100px;
            background-position: 0 0, 0 100%, 60px 100%; opacity: 0.5; z-index: 1;
        }
        /* Capa 2: Pinos */
        .bg-trees {
            background-image: radial-gradient(circle at 50% 100%, #1e3c2f 10%, transparent 12%),
                              radial-gradient(circle at 50% 100%, #162b22 10%, transparent 12%);
            background-size: 80px 150px; background-position: 0 0, 420px 60px;
            z-index: 2; opacity: 0.8;
        }

        /* --- EFECTOS VISUALES --- */
        .speed-lines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 18;
            background: transparent; opacity: 0; transition: opacity 0.5s;
        }
        .speed-lines.active {
            opacity: 0.6;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(255,255,255,0.1) 50px, rgba(255,255,255,0.1) 120px);
            animation: scrollLines 0.2s linear infinite;
        }
        @keyframes scrollLines { from { background-position: 0 0; } to { background-position: 0 120px; } }
        
        /* MODO FIESTA */
        @keyframes disco {
            0% { background-color: rgba(255, 0, 0, 0.2); } 25% { background-color: rgba(0, 255, 0, 0.2); }
            50% { background-color: rgba(0, 0, 255, 0.2); } 75% { background-color: rgba(255, 255, 0, 0.2); }
            100% { background-color: rgba(255, 0, 255, 0.2); }
        }
        .party-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15;
            pointer-events: none; display: none; mix-blend-mode: overlay;
        }
        .party-overlay.active { display: block; animation: disco 0.5s infinite; }

        /* MODO SLOW MOTION */
        .slowmo-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 16;
            pointer-events: none; background: rgba(52, 152, 219, 0.2);
            opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(2px);
        }
        .slowmo-overlay.active { opacity: 1; }

        /* Nieve */
        .snowflake {
            position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.8;
            animation: fall linear infinite; pointer-events: none; z-index: 15;
        }
        @keyframes fall { to { transform: translateY(105vh); } }

        /* Elementos Juego */
        .road-line { position: absolute; width: 10px; height: 70px; background-color: rgba(255,255,255,0.7); left: 50%; transform: translateX(-50%); border-radius: 4px; z-index: 3; }
        
        #header { position: absolute; top: 0; width: 100%; height: 75px; background: rgba(255, 255, 255, 0.95); z-index: 25; display: flex; align-items: center; justify-content: center; border-bottom: 4px solid #2980b9; box-shadow: 0 5px 20px rgba(0,0,0,0.6); }
        #header img { max-height: 55px; max-width: 85%; object-fit: contain; }
        
        #player { 
            position: absolute; bottom: 130px; left: 50%; 
            transform: translateX(-50%); transition: left 0.1s cubic-bezier(0.2, 0.6, 0.4, 1); 
            z-index: 10; width: 80px; height: 80px; 
            display: flex; justify-content: center; align-items: flex-end;
        }
        .player-emoji { font-size: 60px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8)); }
        .player-img { 
            width: 75px; height: 75px; border-radius: 50%; 
            border: 3px solid #fff; object-fit: cover; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.8); background: #fff;
        }
        
        #player.invincible .player-img, #player.invincible .player-emoji {
            filter: drop-shadow(0 0 20px #f1c40f) brightness(1.2); animation: shake 0.2s infinite;
        }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } 100% { transform: translateX(0); } }

        .obstacle, .gift, .powerup, .slowmo { position: absolute; z-index: 5; text-align: center; transition: transform 0.1s; }
        .obstacle { font-size: 45px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }
        .obstacle.destroyed { transform: scale(1.5) rotate(45deg); opacity: 0; transition: all 0.2s; }
        .gift { font-size: 45px; filter: drop-shadow(0 0 15px #f1c40f); animation: pulse 0.5s infinite alternate; }
        .powerup { width: 50px; height: 50px; background: #fff; border-radius: 50%; border: 3px solid #3498db; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 25px #3498db; animation: spin 2s infinite linear; }
        .powerup img { width: 40px; }
        .slowmo { font-size: 45px; filter: drop-shadow(0 0 15px #00ffff); animation: pulse 1s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.15); } }

        /* UI */
        .points-float {
            position: absolute; font-weight: 900; font-size: 28px; z-index: 30; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.9); animation: floatUp 0.8s forwards;
        }
        @keyframes floatUp { from { transform: translateY(0) scale(1); opacity:1;} to { transform: translateY(-80px) scale(1.5); opacity: 0; } }

        #shield-bar {
            position: absolute; bottom: 110px; left: 50%; transform: translateX(-50%);
            width: 0px; height: 8px; background: linear-gradient(90deg, #f1c40f, #e67e22); border-radius: 4px;
            z-index: 20; box-shadow: 0 0 10px #f1c40f; transition: width 0.1s linear;
        }

        #score-board { position: absolute; top: 90px; right: 15px; color: #fff; font-weight: 800; font-size: 18px; background: linear-gradient(90deg, #c0392b, #e74c3c); padding: 8px 18px; border-radius: 50px; z-index: 25; border: 2px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-shadow: 1px 1px 2px black;}
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 15, 20, 0.98); z-index: 40; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; backdrop-filter: blur(10px); padding: 20px; box-sizing: border-box; overflow-y: auto; }
        
        h1 { color: #3498db; text-transform: uppercase; margin-bottom: 5px; font-size: 26px; text-shadow: 0 4px 10px rgba(0,0,0,0.8); letter-spacing: 1px; }
        .subtitle { color: #f1c40f; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0; max-width: 350px; }
        .char-option { 
            width: 65px; height: 65px; border-radius: 50%; background: rgba(255,255,255,0.05);
            border: 3px solid #555; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            position: relative; margin: 0 auto;
        }
        .char-option img { width: 100%; height: 100%; object-fit: cover; }
        .char-option.selected { border-color: #2ecc71; box-shadow: 0 0 15px #2ecc71; transform: scale(1.1); background: rgba(255,255,255,0.2); }
        .char-emoji { font-size: 35px; }
        .char-option.santa-mode { border-color: #e74c3c; }
        .char-option.santa-mode.selected { box-shadow: 0 0 25px #e74c3c; }

        /* TARJETA FINAL */
        .christmas-card {
            animation: popIn 0.8s ease; background: #fff; color: #333;
            width: 100%; max-width: 350px; border-radius: 15px; padding: 25px 20px;
            box-shadow: 0 20px 70px rgba(0,0,0,1); border-top: 10px solid #c0392b; border-bottom: 10px solid #2980b9; 
        }
        .card-title { font-size: 28px; color: #c0392b; font-family: serif; font-weight: bold; margin: 5px 0; }
        .card-score { font-size: 45px; font-weight: 900; color: #2c3e50; margin: 0; }
        .card-label { font-size: 12px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }
        
        /* BOCADILLO DE FRASE GRACIOSA */
        .quote-bubble {
            background: #fdf2e9; border: 2px solid #f39c12; border-radius: 10px;
            padding: 10px; margin: 15px 0; position: relative;
        }
        .quote-bubble:after {
            content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            border-width: 0 10px 10px; border-style: solid; border-color: #f39c12 transparent; display: block; width: 0;
        }
        #fun-quote { font-style: italic; color: #d35400; font-weight: 600; font-size: 14px; margin: 0; }
        #quote-author { display: block; text-align: right; font-size: 11px; color: #777; margin-top: 5px; text-transform: uppercase; }

        .card-message { margin-top: 10px; font-size: 15px; line-height: 1.5; color: #555; border-top: 1px solid #eee; padding-top: 10px; }
        .company-highlight { color: #2980b9; font-weight: 900; font-size: 16px; }

        button { 
            background: #34495e; color: white; border: none; padding: 14px 30px; font-size: 16px; 
            border-radius: 50px; cursor: pointer; margin-top: 10px; font-weight: bold; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: all 0.1s; text-transform: uppercase; width: 100%;
        }
        button:active { transform: scale(0.98); }
        .btn-play { background: linear-gradient(90deg, #2980b9, #3498db); }
        .btn-whatsapp { background: linear-gradient(90deg, #25D366, #128C7E); display: inline-flex; align-items: center; justify-content: center; gap: 10px; }

        @keyframes popIn { 0% { transform: scale(0.6); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- CAPAS PARALLAX -->
        <div class="parallax-layer bg-mountains" id="bg-mountains"></div>
        <div class="parallax-layer bg-trees" id="bg-trees"></div>

        <!-- EFECTOS VISUALES -->
        <div id="speed-lines" class="speed-lines"></div>
        <div id="party-overlay" class="party-overlay"></div>
        <div id="slowmo-overlay" class="slowmo-overlay"></div>

        <!-- CABECERA -->
        <div id="header">
            <img src="ANAGRAMA.jpg" alt="CV Tools" onerror="this.src='https://via.placeholder.com/300x80/ffffff/2980b9?text=CV+Tools'">
        </div>

        <div id="score-board">PUNTOS: <span id="score">0</span></div>
        
        <!-- JUGADOR + Barra Escudo -->
        <div id="player"></div>
        <div id="shield-bar"></div>

        <!-- PANTALLA INICIO -->
        <div id="start-screen" class="screen">
            <h1 style="color:#fff; margin-bottom: 0;">Reto Navidad</h1>
            <div class="subtitle">CV TOOLS EDITION</div>
            
            <p style="color:#bbb; font-size: 13px;">Elige a tu conductor:</p>
            
            <div class="char-grid">
                <!-- Fila 1 -->
                <div class="char-option" onclick="selectChar('pablo', this)">
                    <img src="Pablo.png" onerror="this.src='https://ui-avatars.com/api/?name=Pablo&background=random&color=fff'">
                </div>
                <div class="char-option" onclick="selectChar('olga', this)">
                    <img src="Olga.png" onerror="this.src='https://ui-avatars.com/api/?name=Olga&background=random&color=fff'">
                </div>
                <div class="char-option" onclick="selectChar('carmen', this)">
                    <img src="Carmen.png" onerror="this.src='https://ui-avatars.com/api/?name=Carmen&background=random&color=fff'">
                </div>
                <!-- Fila 2 -->
                <div class="char-option" onclick="selectChar('rebeca', this)">
                    <img src="Rebeca.png" onerror="this.src='https://ui-avatars.com/api/?name=Rebeca&background=random&color=fff'">
                </div>
                <!-- SANTA (Default) -->
                <div class="char-option santa-mode selected" onclick="selectChar('santa', this)">
                    <span class="char-emoji">üéÖ</span>
                </div>
                <div class="char-option" onclick="selectChar('sayo', this)">
                    <img src="Sayo.png" onerror="this.src='https://ui-avatars.com/api/?name=Sayo&background=random&color=fff'">
                </div>
            </div>
            
            <div id="char-name-display" style="color: #e74c3c; font-weight: bold; margin-bottom: 10px; font-size: 18px; text-transform: uppercase;">SANTA</div>
            
            <div id="high-score-display" style="font-size: 12px; color: #f1c40f; margin-bottom: 10px; font-weight: bold; border: 1px solid #f1c40f; padding: 5px 10px; border-radius: 10px;">
                üèÜ TU R√âCORD: 0
            </div>

            <p style="font-size: 12px; color: #aaa; margin-bottom: 15px; line-height: 1.4;">
                üéÅ Regalo (+5) | üõ°Ô∏è Logo (Invencible) | ‚ùÑÔ∏è Copo (Slow Motion)
            </p>

            <button class="btn-play" onclick="startGame()">‚ñ∂ JUGAR AHORA üîä</button>
        </div>

        <!-- PANTALLA RESULTADO -->
        <div id="result-screen" class="screen hidden">
            <div class="christmas-card">
                <div class="card-label">Puntuaci√≥n Final</div>
                <div class="card-score" id="final-score">0</div>
                <div id="new-record-msg" style="color: #f1c40f; font-weight: bold; font-size: 14px; display:none;">‚ú® ¬°NUEVO R√âCORD! ‚ú®</div>
                
                <!-- FRASES GRACIOSAS AQU√ç -->
                <div class="quote-bubble">
                    <p id="fun-quote">"Ups, eso ha dolido..."</p>
                    <span id="quote-author">- CONDUCTOR</span>
                </div>

                <div class="card-title">¬°Feliz Navidad!</div>
                
                <div class="card-message">
                    El equipo de <span class="company-highlight">CV TOOLS</span> te desea unas fiestas llenas de alegr√≠a y un 2026 lleno de √©xitos.
                </div>

                <button class="btn-whatsapp" onclick="shareWhatsapp()">
                    <span>üí¨</span> Compartir mi r√©cord
                </button>
                <button class="btn-play" style="margin-top: 10px; background: #7f8c8d;" onclick="resetGame()">
                    üîÑ Intentar superar
                </button>
            </div>
        </div>
    </div>

    <script>
        /* --- DICCIONARIO DE FRASES DIVERTIDAS --- */
        const characterQuotes = {
            'SANTA': [
                "¬°Jo Jo Nooo! Se me han ca√≠do los regalos...",
                "Esto con los renos no pasaba.",
                "¬°La leche! ¬°Qu√© golpe!",
                "Necesito el taller de reparaciones del Polo Norte."
            ],
            'PABLO': [
                "La pr√≥xima vez que nos veamos analizamos este choque.",
                "Ese cono no estaba en el presupuesto.",
                "Cuando me coma el bocadillo de almorzar lo esquivo fijo.",
                "Esa valla no estaba en el presupuesto"
            ],
            'OLGA': [
                "Ese cono no estaba en el presupuesto.",
                "Ma√±ana a primera hora gestiono este incidente.",
                "¬°Ay! Mi T-Roc nuevo...",
                "Esto no cumple la normativa ISO de conducci√≥n."
            ],
            'CARMEN': [
                "¬°Ups! Me ha pillado en Mercurio retr√≥grado.",
                "Redirigiendo ruta... Menuda leche!",
                "¬øAlguien tiene el n√∫mero de la gr√∫a? Madre de Dios",
                "¬øEso era una se√±al MOPU o econ√≥mica?"
            ],
            'REBECA': [
                "Esto lo arreglo yo en un momento.",
                "¬°Ups! Me ha pillado en Mercurio retr√≥grado.",
                "¬øEso era una se√±al MOPU o econ√≥mica?",
                "Menos mal que tenemos seguro a todo riesgo."
            ],
            'SAYO': [
                "Uff.. que golpe...Llama al comercial de la zona",
                "La agencia ha tenido la culpa. Lo sabemos todos",
                "La seguridad vial es lo primero (menos hoy).",
                "¬°Crash! Sistema reiniciando..."
            ]
        };

        /* --- MOTOR DE AUDIO (SYNTHESIS) --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const SoundFX = {
            playTone: (freq, type, duration) => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            gift: () => {
                SoundFX.playTone(880, 'sine', 0.1);
                setTimeout(() => SoundFX.playTone(1760, 'sine', 0.2), 100);
            },
            powerup: () => {
                SoundFX.playTone(400, 'square', 0.1);
                setTimeout(() => SoundFX.playTone(600, 'square', 0.1), 100);
                setTimeout(() => SoundFX.playTone(1000, 'square', 0.3), 200);
            },
            slowmo: () => { SoundFX.playTone(1200, 'sine', 0.5); },
            crash: () => {
                SoundFX.playTone(100, 'sawtooth', 0.5);
                SoundFX.playTone(50, 'square', 0.5);
            }
        };

        /* --- CONFIGURACI√ìN --- */
        const INITIAL_SPEED = 9;
        const MAX_SPEED = 24;
        
        /* DOM */
        const container = document.getElementById('game-container');
        const playerEl = document.getElementById('player');
        const scoreEl = document.getElementById('score');
        const startScreen = document.getElementById('start-screen');
        const resultScreen = document.getElementById('result-screen');
        const finalScoreEl = document.getElementById('final-score');
        const highScoreDisplay = document.getElementById('high-score-display');
        const shieldBar = document.getElementById('shield-bar');
        
        // Efectos
        const speedLines = document.getElementById('speed-lines');
        const partyOverlay = document.getElementById('party-overlay');
        const slowmoOverlay = document.getElementById('slowmo-overlay');
        const bgTrees = document.getElementById('bg-trees');
        const bgMountains = document.getElementById('bg-mountains');

        /* VARIABLES */
        let gameRunning = false;
        let score = 0;
        let highScore = localStorage.getItem('cvToolsHighScore') || 0;
        let playerPos = 50; 
        
        let items = [];
        let roadLines = [];
        
        let gameSpeed = INITIAL_SPEED;
        let spawnRate = 45;
        let frameCount = 0;
        let animId;
        
        let isInvincible = false;
        let isSlowMo = false;
        let invincibleTimer, slowMoTimer;
        
        let currentDriver = { type: 'emoji', val: 'üéÖ', name: 'SANTA' };

        highScoreDisplay.innerText = `üèÜ TU R√âCORD: ${highScore}`;

        /* NIEVE */
        function createSnow() {
            setInterval(() => {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.style.left = Math.random() * 100 + '%';
                flake.style.width = flake.style.height = (Math.random() * 4 + 2) + 'px';
                flake.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(flake);
                setTimeout(() => flake.remove(), 4000);
            }, 100);
        }
        createSnow();

        /* SELECCI√ìN DE PERSONAJE */
        function selectChar(charType, element) {
            document.querySelectorAll('.char-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            const nameDisplay = document.getElementById('char-name-display');
            let name = charType.toUpperCase();
            let color = '#3498db'; 

            if (charType === 'santa') {
                currentDriver = { type: 'emoji', val: 'üéÖ', name: 'SANTA' };
                color = '#e74c3c';
            } else {
                let filename = charType.charAt(0).toUpperCase() + charType.slice(1) + ".png";
                currentDriver = { type: 'img', val: filename, name: name };
                color = '#2ecc71';
            }
            nameDisplay.style.color = color;
            nameDisplay.innerText = currentDriver.name;
        }

        function renderPlayer() {
            playerEl.innerHTML = '';
            if (currentDriver.type === 'emoji') {
                const span = document.createElement('span');
                span.className = 'player-emoji';
                span.innerText = currentDriver.val;
                playerEl.appendChild(span);
            } else {
                const img = document.createElement('img');
                img.className = 'player-img';
                img.src = currentDriver.val;
                img.onerror = function() { this.src = `https://ui-avatars.com/api/?name=${currentDriver.name}&background=random&color=fff`; };
                playerEl.appendChild(img);
            }
        }

        /* MOVIMIENTO */
        function moveLeft() { if(playerPos > 15) playerPos -= 20; updatePlayerPos(); }
        function moveRight() { if(playerPos < 85) playerPos += 20; updatePlayerPos(); }
        
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            if (e.key === 'ArrowLeft') moveLeft();
            if (e.key === 'ArrowRight') moveRight();
        });

        container.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON' || e.target.closest('.char-option')) return;
            if (!gameRunning) return;
            const rect = container.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            if ((clientX - rect.left) < rect.width / 2) moveLeft();
            else moveRight();
        });

        function updatePlayerPos() { playerEl.style.left = playerPos + '%'; }

        /* JUEGO */
        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            renderPlayer();
            startScreen.classList.add('hidden');
            resetVariables();
            gameRunning = true;
            gameLoop();
        }

        function resetGame() {
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            highScoreDisplay.innerText = `üèÜ TU R√âCORD: ${localStorage.getItem('cvToolsHighScore') || 0}`;
        }

        function resetVariables() {
            score = 0; scoreEl.innerText = score;
            playerPos = 50; updatePlayerPos();
            
            items.forEach(i => i.el.remove());
            roadLines.forEach(l => l.el.remove());
            items = []; roadLines = [];
            
            gameSpeed = INITIAL_SPEED; spawnRate = 45; frameCount = 0;
            deactivateInvincibility();
            deactivateSlowMo();
            speedLines.classList.remove('active');
            
            if(animId) cancelAnimationFrame(animId);
        }

        /* SPAWNERS */
        function createItem(type) {
            const lanes = [10, 30, 50, 70, 90];
            const lane = lanes[Math.floor(Math.random() * lanes.length)];
            if(items.some(i => Math.abs(i.top - (-80)) < 120 && i.lane === lane)) return;

            const el = document.createElement('div');
            let itemObj = { el, top: -80, lane, type };

            if (type === 'obstacle') {
                el.className = 'obstacle';
                const types = ['üöß', '‚õî', 'üõë', '‚ö†Ô∏è'];
                el.innerText = types[Math.floor(Math.random() * types.length)];
            } 
            else if (type === 'gift') {
                el.className = 'gift'; el.innerText = 'üéÅ';
            }
            else if (type === 'powerup') {
                el.className = 'powerup';
                el.innerHTML = `<img src="ANAGRAMA.jpg" onerror="this.src='https://via.placeholder.com/40/ffffff/2980b9?text=CV'">`;
            }
            else if (type === 'slowmo') {
                el.className = 'slowmo'; el.innerText = '‚ùÑÔ∏è';
            }

            el.style.left = lane + '%'; el.style.top = '-80px';
            container.appendChild(el);
            items.push(itemObj);
        }

        /* PODERES */
        function activateInvincibility() {
            SoundFX.powerup();
            isInvincible = true;
            playerEl.classList.add('invincible');
            partyOverlay.classList.add('active'); // MODO FIESTA
            shieldBar.style.width = '80px';
            showFloatText('¬°ESCUDO CV TOOLS!', '#3498db');
            if(invincibleTimer) clearTimeout(invincibleTimer);
            invincibleTimer = setTimeout(deactivateInvincibility, 5000);
        }

        function deactivateInvincibility() {
            isInvincible = false;
            playerEl.classList.remove('invincible');
            partyOverlay.classList.remove('active');
            shieldBar.style.width = '0px';
        }

        function activateSlowMo() {
            SoundFX.slowmo();
            isSlowMo = true;
            slowmoOverlay.classList.add('active');
            showFloatText('¬°SLOW MOTION!', '#00ffff');
            let originalSpeed = gameSpeed;
            gameSpeed = 5; 
            if(slowMoTimer) clearTimeout(slowMoTimer);
            slowMoTimer = setTimeout(() => { deactivateSlowMo(originalSpeed); }, 4000);
        }

        function deactivateSlowMo(targetSpeed) {
            isSlowMo = false;
            slowmoOverlay.classList.remove('active');
            if(targetSpeed) gameSpeed = targetSpeed;
            else gameSpeed = Math.max(INITIAL_SPEED, gameSpeed);
        }

        function showFloatText(text, color) {
            const floatText = document.createElement('div');
            floatText.className = 'points-float';
            floatText.innerText = text;
            floatText.style.color = color;
            floatText.style.left = '50%';
            floatText.style.transform = 'translateX(-50%)';
            floatText.style.top = (container.offsetHeight - 250) + 'px';
            container.appendChild(floatText);
            setTimeout(() => floatText.remove(), 800);
        }

        /* LOOP PRINCIPAL */
        function gameLoop() {
            if (!gameRunning) return;
            frameCount++;
            
            // GENERACI√ìN
            if (frameCount % Math.floor(spawnRate) === 0) createItem('obstacle');
            if (frameCount % (Math.floor(spawnRate) * 4) === 0 && Math.random() > 0.4) createItem('gift');
            if (frameCount % 600 === 0) createItem('powerup'); 
            if (frameCount % 900 === 0) createItem('slowmo');

            // L√çNEAS
            if (frameCount % 10 === 0) { 
                const l = document.createElement('div');
                l.className = 'road-line'; l.style.top = '-70px';
                container.appendChild(l);
                roadLines.push({ el: l, top: -70 });
            }
            
            // DIFICULTAD Y PARALLAX
            if (!isSlowMo && frameCount % 300 === 0) {
                if (gameSpeed < MAX_SPEED) gameSpeed += 1;
                if (spawnRate > 20) spawnRate -= 2;
                if (gameSpeed > 15) speedLines.classList.add('active');
            }

            bgTrees.style.backgroundPositionY = (frameCount * (gameSpeed * 0.5)) + 'px';
            bgMountains.style.backgroundPositionY = (frameCount * (gameSpeed * 0.1)) + 'px';

            // F√çSICAS
            items.forEach((item, i) => {
                item.top += gameSpeed;
                item.el.style.top = item.top + 'px';
                
                if (item.top > container.offsetHeight - 140 && item.top < container.offsetHeight - 50) {
                    if (Math.abs(item.lane - playerPos) < 15) {
                        
                        if (item.type === 'obstacle') {
                            if (isInvincible) {
                                item.el.classList.add('destroyed');
                                SoundFX.crash();
                                score += 2; scoreEl.innerText = score;
                                items.splice(i, 1);
                                setTimeout(() => item.el.remove(), 200);
                                return;
                            } else {
                                SoundFX.crash();
                                finishGame();
                            }
                        } 
                        else if (item.type === 'gift') {
                            SoundFX.gift();
                            showFloatText('+5', '#f1c40f');
                            score += 5; scoreEl.innerText = score;
                            item.el.remove(); items.splice(i, 1);
                        }
                        else if (item.type === 'powerup') {
                            activateInvincibility();
                            item.el.remove(); items.splice(i, 1);
                        }
                        else if (item.type === 'slowmo') {
                            activateSlowMo();
                            item.el.remove(); items.splice(i, 1);
                        }
                    }
                }
                
                if (item.top > container.offsetHeight) {
                    if(item.type === 'obstacle') { score++; scoreEl.innerText = score; }
                    item.el.remove(); items.splice(i, 1);
                }
            });

            roadLines.forEach((l, i) => {
                l.top += gameSpeed; l.el.style.top = l.top + 'px';
                if (l.top > container.offsetHeight) { l.el.remove(); roadLines.splice(i, 1); }
            });

            if (gameRunning) animId = requestAnimationFrame(gameLoop);
        }

        /* FIN */
        function finishGame() {
            gameRunning = false;
            finalScoreEl.innerText = score;
            
            // FRASES GRACIOSAS
            const driverName = currentDriver.name;
            const quoteEl = document.getElementById('fun-quote');
            const authorEl = document.getElementById('quote-author');
            
            const quotes = characterQuotes[driverName] || characterQuotes['SANTA'];
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            quoteEl.innerText = `"${randomQuote}"`;
            authorEl.innerText = `- ${driverName}`;

            // R√©cord
            let isNewRecord = false;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('cvToolsHighScore', highScore);
                isNewRecord = true;
            }
            document.getElementById('new-record-msg').style.display = isNewRecord ? 'block' : 'none';

            resultScreen.classList.remove('hidden');
        }

        /* COMPARTIR */
        function shareWhatsapp() {
            const driverName = currentDriver.name;
            const text = `üéÖ Reto Navidad CV TOOLS üéÖ\n\n¬°He logrado ${score} puntos con ${driverName}!\n\n¬øPuedes superar mi r√©cord?\n\nJuega aqu√≠:`;
            const url = window.location.href;
            const waUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text + " " + url)}`;
            window.open(waUrl, '_blank');
        }
    </script>
</body>
</html>